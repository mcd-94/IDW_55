<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Administración - MedicalIDW</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="../../styles/global.css" />
<link rel="stylesheet" href="../../styles/admin_dashboard.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
 <header>
      <div class="header-content-container" id="headerContentContainer">

        <div>
          <a href="../../index.html">
            <img src="../../assets/logos/logoHeader.png" id="logoHeader"/>
          </a>
        </div>

        <nav id="mainNavMenu">
          <ul>
            <li class="menu-element">
                <a href="#" class="nav-link">Médicos</a>
            </li>
            <li class="menu-element">
              <a href="#" class="nav-link">Reservas</a>
            </li>
            <li class="menu-element">
              <a href="#" class="nav-link">Especialidades</a>
            </li>
            <li class="menu-element">
              <a href="#" class="nav-link">Obras Sociales</a>
            </li>
            <li class="menu-element">
              <a href="#" class="nav-link">Turnos</a>
            </li>
          </ul>
        </nav>
        <div class="d-flex align-items-center gap-3">
          <a href="../login/login.html">
            <button id="logoutBtn" class="btn btn-light btn-sm">
              <i class="bi bi-box-arrow-right"></i>
            </button>
          </a>
          <div class="burger-button-container">
            <button id="burgerButton">
              <svg id="burgerIcon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <rect y="4" width="24" height="2" fill="#ffffff" rx="1"></rect>
                <rect y="11" width="24" height="2" fill="#ffffff" rx="1"></rect>
                <rect y="18" width="24" height="2" fill="#ffffff" rx="1"></rect>
              </svg>
              <svg id="closeIcon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="hidden">
                <line x1="4" y1="4" x2="20" y2="20" stroke="#ffffff" stroke-width="2" stroke-linecap="round" />
                <line x1="20" y1="4" x2="4" y2="20" stroke="#ffffff" stroke-width="2" stroke-linecap="round" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </header>
    <div id="backdrop" class="hidden"></div>

<div class="main-content container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
                <h2 class="dashboardAdminTitle mb-3 mb-md-0">Panel de Administración - Medicos</h2>
                <div class="d-flex gap-2">
                    <button id="btnNuevo" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nuevo Médico
                    </button>
                    <div class="input-group" style="width: 250px;">
                        <input type="text" id="searchInput" class="form-control" placeholder="Buscar...">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Apellidos</th>
                                    <th>Nombres</th>
                                    <th>DNI</th>
                                    <th>Teléfono</th>
                                    <th>Especialidad</th>
                                    <th>Matrícula</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaMedicos"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalMedico" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Nuevo Médico</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="medicoId">
                <div class="mb-3">
                    <label for="apellidos" class="form-label">Apellidos</label>
                    <input type="text" class="form-control" id="apellidos" placeholder="Apellidos">
                </div>
                <div class="mb-3">
                    <label for="nombres" class="form-label">Nombres</label>
                    <input type="text" class="form-control" id="nombres" placeholder="Nombres">
                </div>
                <div class="mb-3">
                    <label for="dni" class="form-label">DNI</label>
                    <input type="text" class="form-control" id="dni" placeholder="DNI">
                </div>
                <div class="mb-3">
                    <label for="telefono" class="form-label">Teléfono</label>
                    <input type="text" class="form-control" id="telefono" placeholder="Teléfono">
                </div>
                <div class="mb-3">
                    <label for="especialidad" class="form-label">Especialidad</label>
                    <input type="text" class="form-control" id="especialidad" placeholder="Especialidad">
                </div>
                <div class="mb-3">
                    <label for="matricula" class="form-label">Matrícula</label>
                    <input type="text" class="form-control" id="matricula" placeholder="Matrícula">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="guardarMedico">Guardar</button>
            </div>
        </div>
    </div>
</div>

<footer>
  <div class="copyright">
    <p>© MedicalIDW - Clínica Médica</p>
    <p>Introducción al Desarrollo Web - 2025</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script src="../../scripts/medicos.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM cargado, inicializando aplicación...');
    console.log('Médicos iniciales:', window.medicosIniciales);
    
    if(!localStorage.getItem('medicos')){
        console.log('Inicializando datos de médicos...');
        if (window.medicosIniciales && window.medicosIniciales.length > 0) {
            const inicial = window.medicosIniciales.map((m,i)=>({id:i+1, ...m}));
            localStorage.setItem('medicos', JSON.stringify(inicial));
            console.log('Datos inicializados:', inicial);
        } else {
            console.error('No se encontraron médicos iniciales');
            localStorage.setItem('medicos', JSON.stringify([]));
        }
    }

    let medicoEditarId = null;
    const tabla = document.getElementById('tablaMedicos');
    const modalElement = document.getElementById('modalMedico');
    
    if (!tabla) {
        console.error('No se encontró el elemento tablaMedicos');
        return;
    }
    
    if (!modalElement) {
        console.error('No se encontró el elemento modalMedico');
        return;
    }
    
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap no está cargado');
        return;
    }
    
    const modal = new bootstrap.Modal(modalElement);
    console.log('Modal de Bootstrap inicializado');

    function obtenerMedicos() { 
        const medicos = JSON.parse(localStorage.getItem('medicos')||'[]');
        console.log('Médicos obtenidos:', medicos);
        return medicos;
    }

    function guardarMedicos(medicos) { 
        localStorage.setItem('medicos', JSON.stringify(medicos)); 
    }

    function renderizarTabla(filtro=''){
        console.log('Renderizando tabla con filtro:', filtro);
        
        const medicos = obtenerMedicos();
        console.log('Total de médicos:', medicos.length);
        
        const medicosFiltrados = medicos.filter(m =>
            m.apellidos.toLowerCase().includes(filtro.toLowerCase()) ||
            m.nombres.toLowerCase().includes(filtro.toLowerCase()) ||
            m.dni.toString().includes(filtro)
        );
        
        console.log('Médicos después del filtro:', medicosFiltrados.length);
        
        if (medicosFiltrados.length === 0) {
            tabla.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        No se encontraron médicos
                    </td>
                </tr>
            `;
            return;
        }
        
        tabla.innerHTML = medicosFiltrados.map(m => `
            <tr data-id="${m.id}">
                <td>${m.apellidos}</td>
                <td>${m.nombres}</td>
                <td>${m.dni}</td>
                <td>${m.telefono}</td>
                <td>${m.especialidad}</td>
                <td>${m.matricula}</td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary editar-btn">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-outline-danger eliminar-btn">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    tabla.addEventListener('click', e => {
        const button = e.target.closest('button');
        if(!button) return;
        
        const tr = button.closest('tr');
        if(!tr) return;
        
        const id = parseInt(tr.dataset.id);
        
        if(button.classList.contains('editar-btn')){
            const m = obtenerMedicos().find(x=>x.id===id);
            medicoEditarId = id;
            document.getElementById('modalTitle').textContent = 'Editar Médico';
            ['apellidos','nombres','dni','telefono','especialidad','matricula'].forEach(f=>
                document.getElementById(f).value = m[f]
            );
            modal.show();
        }
        
        if(button.classList.contains('eliminar-btn')){
            if(!confirm('¿Está seguro que desea eliminar este médico?')) return;
            let medicos = obtenerMedicos();
            medicos = medicos.filter(x=>x.id!==id);
            guardarMedicos(medicos);
            renderizarTabla(document.getElementById('searchInput').value);
        }
    });

    document.getElementById('btnNuevo').addEventListener('click', () => {
        medicoEditarId = null;
        document.getElementById('modalTitle').textContent = 'Nuevo Médico';
        ['apellidos','nombres','dni','telefono','especialidad','matricula'].forEach(f=>
            document.getElementById(f).value = ''
        );
        modal.show();
    });

    document.getElementById('guardarMedico').addEventListener('click', () => {
        const m = {};
        let camposCompletos = true;
        
        ['apellidos','nombres','dni','telefono','especialidad','matricula'].forEach(f => {
            m[f] = document.getElementById(f).value.trim();
            if(!m[f]) { 
                alert('Complete todos los campos'); 
                camposCompletos = false;
                return;
            }
        });
        
        if (!camposCompletos) return;
        
        const medicos = obtenerMedicos();
        if(medicoEditarId){
            const idx = medicos.findIndex(x=>x.id===medicoEditarId);
            medicos[idx] = {id:medicoEditarId, ...m};
        } else {
            const nuevoId = medicos.length ? Math.max(...medicos.map(x=>x.id))+1 : 1;
            medicos.push({id:nuevoId, ...m});
        }
        
        guardarMedicos(medicos);
        modal.hide();
        renderizarTabla(document.getElementById('searchInput').value);
    });

    document.getElementById('searchInput').addEventListener('input', e => {
        renderizarTabla(e.target.value);
    });

    renderizarTabla();
});
</script>
<script src="../../scripts/burgerMenu.js"></script>
</body>
</html>